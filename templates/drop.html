<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Drop Bucket</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Motokazu Nishimura">
	<!-- Date: 2010-06-16 -->
	<script src="{{ assets }}script/jquery-1.4.2.min.js"></script>
	<script src="{{ assets }}script/jquery.json-2.2.min.js"></script>
<script>
var dropbox;
function init(){
	dropbox = document.getElementById("dropbox");
	dropbox.addEventListener("dragenter", dragenter, true);
	dropbox.addEventListener("dragleave", dragleave, true);
	dropbox.addEventListener("dragover", dragover, true);
	dropbox.addEventListener("drop", drop, true);
}
function dragenter(e){
	dropbox.setAttribute("dragenter",true);
}
function dragleave(e){
	dropbox.removeAttribute("dragenter");
}
function dragover(e){
	e.preventDefault();
}
function drop(e){
	var dt = e.dataTransfer;
	var files = dt.files;
	e.preventDefault();

	//alert("dropped "+files.length+" files.");
	for(var i = 0;i < files.length ; i++){
		var file = files[i];
		handleFile(file);
	}
}
function handleFile(file){
	var tag = '';
	tag = prompt("Please input tags ["+file.name+"]:","");

	var reader = new FileReader();
	reader.onloadend = function(){
		var result = reader.result;
		var base64str = result.slice(result.indexOf("base64,")+7);
		post(file.name,file.type,base64str,tag);
	}
	reader.readAsDataURL(file);
}

window.addEventListener("load", init, true);

function post(name, type, data, tags){
	var json = {
		"tags" : tags,
		"_attachments": {}
	};
	var t = new Date();
	json.ctime = t.toString();
	json['_attachments'][name] = {
		"content_type" : type,
		"data" : data
	};
	$.ajax({
		type: 'POST',
		url: '/dropbucket/',
		dataType: 'json',
		contentType: 'application/json',
		data: $.toJSON(json),
		processData: false,		
		success: function(data, dataType){
			alert("Success!");
		},
		error: function(msg){
			alert("Failed.");
		}
	});
}
</script>
<style type="text/css">
#dropbox {
	font-family:monospace;
	font-style:bold;
	border:1px solid;
	width:1000px;
	height:600px;
	text-align:center;
	clear:both;
	float:left;
}
#dropbox[dragenter="true"]{
	background-color: #ff9;
}
#filedata {
	width:800px;
	word-wrap: break-word;
	font-size:8px;
}
</style>
</head>
<body>
<a href="{{ assets }}index.html">index</a> &lt; <a href="{{ assets }}_show/album">Album</a>
<hr size="1">
<div id="dropbox">drop here.</div>
<div id="profile">Name is Motokazu</div>
</body>
</html>
